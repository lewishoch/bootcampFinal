<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Order Histroy</title>
        <script src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
		<script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>		
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
</head>
<body>
<div id="content">
    <div id="orderList">
        <div id="oid">
            <div class="shop">
                <div clss="shopName">sname</div>
            </div>
            <div class="dishList">
                <div id='001'>
                    <div class="dishImage">image</div>
                    <div class="dishInfo">
                        <div class="dishName">dname</div>
                        <div class="dishCat">Seafood</div>
                        <div class="dishPrice">10.00</div>
                        <div class="dishNumber">0</div>
                    </div>
                </div>
            </div>
            <div class="totalPrice">
                10.00
            </div>
            <div class="feedback">
                <div class="rating">
                    <input type="text" />
                </div>
                <div class="comment">
                    <input type="text" placeholder="Comment..."/>
                    <button type="button" onclick="sendComment">Send</button>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    var curShop = {};
    var allDish = {};
    var allComment = {};
    var cart = {};
    
    $(function(){
        // ajax get shop, all dish, cart, comment
        var aUrl = "";

        $.ajax({
            type:'GET',
            url:aUrl,
            data:{'mid':curShop.mid}
        }).done(function(data){
            try{
                data = JSON.parse(data);
            }
            catch(e){
                return;
             }
            cart = data.cart;
            allDish = data.dish;
            allComment = data.comments;
            curShop = data.merchant;
            displayAllOrder();
        });
    });
    
    var displayAllOrder = function(){
        // create order
        var o;
        for(var i=0; i<orderList.length; ++i){
            o = orderList[i];
            var order = $('<div id="'+o.oid+'"></div>');
            // display shop
            displayShop(order);
            
            // display order
            displayAllDish(order, o.dishes);
        }
    }
    
     var displayShop = function(parent){
        var shop = $('<div class="shop"></div>');
        var shopName = $('<div class="shopName">'+curShop.name+'</div>');
        shopName.appendTo(shop);
        shop.appendTo(parent);
    }
    
    var displayAllDish = function(parent, data){
        
        var dishList = $('<div class="dishList"></div>');
        var dish, dishImage,dishInfo,dishName,dishCat,dishPrice,dishNumber,control,btn;
        var d;
        
        // dish list
        for(var i=0; i<data.length; ++i){
            d = data[i];
            dish = $('<div id='+d.did+'></div>');
            dishImage = $('<div class="dishImage"><img src="'+d.picPath+'"/></div>');
            dishInfo = $('<div class="dishInfo"></div>');
                dishName = $('<div class="dishName">'+d.dname+'</div>');
                dishCat = $('<div class="dishCat">'+d.cat+'</div>');
                dishPrice = $('<div class="dishPrice">'+d.price+'</div>');
                dishNumber = $('<div class="dishNumber">'+getDishNumber(d.did)+'</div>');
            
            dishName.appendTo(dishInfo);
            dishCat.appendTo(dishInfo);
            dishPrice.appendTo(dishInfo);
            dishNumber.appendTo(dishInfo);
            
            dishImage.appendTo(dish);
            dishInfo.appendTo(dish);
            dish.appendTo(dishList);
            
            console.log(dish)
        }
        dishList.appendTo(parent);
        
        // total price
        var totalPrice = $('<div class="totalPrice">'+getTotalPrice(d.did)+'</div>');
        
    }
    
    var displayAllComment = function(){
        var comment = $('<div></div>');
        var uname,content,date;
        
        var c;
        for(var i=0; i<allComment.length; ++i){
            c = allComment[i];
            uname = $('<div class="commentUname">'+c.uname+'</div>');
            content = $('<div class="commentContent">'+c.content+'</div>');
            date = $('<div class="commentDate">'+c.date+'</div>');
            
            uname.appendTo(comment);
            content.appendTo(comment);
            date.appendTo(comment);
        }
        comment.appendTo($('#comment'));
    }
    
    var updateOrder = function(did){
        var element = $('#'+did+' .control button');
        console.log(element);
        // add to cookie
        console.log(cart);
        cart.dish = (cart.dish instanceof Array)? cart.dish:[];
        
        var index = cart.dish.indexOf(did);
        if(index==-1){
            cart.dish.push({'did':did,'number':number});
            cart.dish.push(did);
            element[0].setAttribute('class','cancelBtn');
            element.text("remove");
        }
        else{
            cart.dish.splice(index, 1);
            element[0].setAttribute('class','orderBtn');
            element.text("add");
        }
            
        console.log(cart);
    }
    
    $(window).on('beforeunload', function() {
        // write into document cookie
        // ajax send update section
        cart.mid = curShop.mid;
        
        var aUrl = "";
        $.ajax({
            type:'POST',
            url:aUrl,
            data:cart
        });
        
    });
    
    var getCookie = function(){
        console.log(document.cookie);
        var name = "mid=";
        var ca = document.cookie.split(';');
        for(var i = 0; i < ca.length; i++) {
            var c = ca[i];
            c = c.trim();
            if (c.indexOf(name) === 0) {
                // cookie found
                var mid = c.substring(name.length, c.length);
                curShop = {};
                curShop.mid = mid;
                break;
            }
        }
    }
    
    var getDishNumber = function(did){
        for(var i=0; i<cart.dish.length; ++i)
            if(cart.dish[i].did==did)
                return cart.dish[i].number;
        return 0;
    }
    
    var getTotalPrice = function(did){
        
    }
    
</script>
</body>
</html>