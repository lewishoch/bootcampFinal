<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Order Histroy</title>
        <script src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous" />
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous" />
		<script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>		
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
       <link type="text/css" rel="stylesheet" href="../css/rater.css" />
		<script src="js/common.js"></script>
		<link rel="stylesheet" href="css/common.css">
</head>
<body>
<div id="header">
    <div id="logo"></div>
    
     <div id="account"><form action="logout" method="GET"><button>Logout</button></form></div>
</div>
<div id="menu">
     <table>
         <tr>
             <td class="menuButton" id="menuMenu">Menu</td>
             <td class="menuButton" id="menuOrders">Orders</td>
             <td class="menuButton" id="menuSetting">Setting</td>
         </tr>
     </table>
</div>
<div id="content">
    <div id="orderList">
        <div id="oid">
           <button type="button" class="status" onclick="changeStatus('oid')">Confirm</button>
            <div class="shop">
                <div class="shopName">sname</div>
            </div>
            <div class="dishList">
                <div class="dishInfo">
                    <div class="dishName">dname</div>
                    <div class="dishPrice">10.00</div>
                    <div class="dishNumber">0</div>
                </div>
            </div>
            <div class="totalPrice">
                10.00
            </div>
            <div class="feedback">
                <div class="rating">
                    <div class="unfixRating">
                        <span onclick="updateRating(this)">☆</span><span  onclick="updateRating(this)">☆</span><span  onclick="updateRating(this)">☆</span><span  onclick="updateRating(this)">☆</span><span  onclick="updateRating(this)">☆</span>
                    </div>
                    <input type="text" hidden/>
                </div>
                <div class="comment">
                    <input type="text" placeholder="Comment..."/>
                    <button type="button" onclick="sendComment('oid')">Send</button>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    
    var orderList = {};
    var blackStar = "\u2605";
    var whiteStar = "\u2606";
    
    $(function(){
        // ajax get shop, all dish, cart, comment
        var aUrl = "viewAllOrders";

        $.ajax({
            type:'GET',
            url:aUrl,
            data:{}
        }).done(function(data){
            orderList = data;
            displayAllOrder();
        });
    });
    
    var displayAllOrder = function(){
        // create order
        var o;
        for(var i=0; i<orderList.length; ++i){
            o = orderList[i];
            var order = $('<div id="'+o.oid+'"></div>');
            
            // display status
            displayStatus(order, {'status':o.status, 'oid':o.oid});
            
            // display shop
            displayShop(order, o.merchant);
            
            // display order
            displayAllDish(order, o.dishes);
            
            // display totalPrice
            displayTotalPrice(order, o.dishes);
            
            // display comment
            displayFeedback(order, {'comment':o.comment, 'rating':o.rating, 'oid':o.oid});
        }
    }
    
    var displayStatus = function(parent, data){
        var s = $('<button type="button" class="status" onclick="changeStatus('+data.oid+')">'+data.status+'</button>');
        s.appendTo(parent);
    }
    
     var displayShop = function(parent, shop){
        var shop = $('<div class="shop"></div>');
        var shopName = $('<div class="shopName">'+shop.name+'</div>');
        shopName.appendTo(shop);
        shop.appendTo(parent);
    }
    
    var displayAllDish = function(parent, data){
        var dishList = $('<div class="dishList"></div>');
        var dish,dishInfo,dishName,dishPrice,dishNumber,control,btn, preTime;

        var d;
        var _dish = data || [];
        
        // dish list
        for(var i=0; i<_dish.length; ++i){
            d = _dish[i];
            dishImage = $('<div class="dishImage"><img src="'+d.picPath+'"/></div>');
            dishInfo = $('<div class="dishInfo"></div>');
                dishName = $('<div class="dishName">'+d.dname+'</div>');
                dishPrice = $('<div class="dishPrice">'+d.price+'</div>');
                dishNumber = $('<div class="dishNumber">'+getDishNumber(d.did)+'</div>');
                var timeDiff = getTimeDiff(d.creDt, d.lastModDt);
                parTime = $('<div class="dishPreTime">'+timeDiff+'</div>');
            dishName.appendTo(dishInfo);
            dishPrice.appendTo(dishInfo);
            dishNumber.appendTo(dishInfo);
            parTime.appendTo(dishInfo);
            
            dishImage.appendTo(dishList);
            dishInfo.appendTo(dishList);
            dish.appendTo(dishList);
            
            console.log(dishList)
        }
        dishList.appendTo(parent);
    }
    
    var displayTotalPrice = function(parent, dishes){
        var total = 0;
        dishes = dishes || [];
        for(var i=0; i<dishes.length; ++i){
            console.log('price: '+dishes[i].dish.price);
            console.log('number: '+dishes[i].quantity)
            total += dishes[i].dish.price * dishes[i].quantity;
        }
        
        // total price
        var totalPrice = $('<div class="totalPrice">'+total+'</div>');
        totalPrice.appendTo(parent);
    }
    
    var displayFeedback = function(parent, data){
        var rating = data.rating;
        var comment = data.comment;
        var oid = data.oid;
        
        var feedbackE = $('<div class="feedback"></div>');
        
        var ratingE = $('<div class="rating"></div>');
        var ratingE2;
        
        if(rating==null || rating==""){
            ratingE2 = $('<div class="unfixRating"></div>');
            var starString = '<span onclick="updateRating(this)">☆</span>';
            var star = $(starString); star.appendTo(ratingE2);
            star = $(starString); star.appendTo(ratingE2); 
            star = $(starString); star.appendTo(ratingE2); 
            star = $(starString); star.appendTo(ratingE2);
            star = $(starString); star.appendTo(ratingE2);
            var input = $('<input type="text" hidden/>');
            input.appendTo(ratingE);
        }
        else{
            ratingE2 = $('<div></div>');
            var whiteStarString = '<span>'+whiteStar+'</span>';
            var blackStarString = '<span>'+blackStar+'</span>';
            var v = rating;
            var star;
            for(var i=1; i<6; ++i){
                star = $((i<=v)? blackStarString:whiteStarString); 
                star.appendTo(ratingE2);
            }
            
            ratingE.text(rating);
        }
        
        var commentE = $('<div class="comment"></div>');
        
        if(comment==null || comment==""){
            $('<input type="text" placeholder="Comment..."/>').appendTo(commentE);
            $('<button type="button" onclick="sendComment('+oid+')">Send</button>').appendTo(commentE);
        }
        else{
            $('<div class="commentUname">'+comment.uname+'</div>').appendTo(commentE);
            $('<div class="commentContent">'+comment.content+'</div>').appendTo(commentE);
        }
        commentE.appendTo(parent);
    }
    
    var sendComment = function(oid){
        var content = $('#'+oid+" .feedback .comment input").val();
        var rating = $('#'+oid+" .feedback .rating input").val();
            
        var aUrl = "";

        $.ajax({
            type:'POST',
            url:aUrl,
            data:JSON.stringify({'oid':oid,"content":content,"rating":rating}),
            contentType:"application/json;charset=UTF-8",
            processData: false
            
        }).done(function(data){
            // update comment
            var parent = $('#'+oid);
            console.log(parent)
            $('.feedback', parent).remove();
            
            var o;
            for(var i=0; i<orderList.length; ++i){
                if(orderList[i].oid==oid){
                    o = orderList[i];
                    o.comment = content;
                    o.rating = rating;
                    displayFeedback(parent, {'comment':o.comment, 'rating':o.rating, 'oid':o.oid});
                    break;
                }
            }
        });
    }
    
    var changeStatus = function(oid){
        var btn = $('#'+oid+" .status button");
        var status = btn.text();
            
        var aUrl = "";

        $.ajax({
            type:'POST',
            url:aUrl,
            data:{'oid':oid,"status":status}
        }).done(function(data){
            // update comment
            var parent = $('#'+oid);
            console.log(parent)
            
            var o;
            for(var i=0; i<orderList.length; ++i){
                if(orderList[i].oid==oid){
                    o = orderList[i];
                    o.status = data.status;
                    btn.text(data.status);
                    break;
                }
            }
            
        });
    }
    
    var updateOrder = function(did){
        var element = $('#'+did+' .control button');
        console.log(element);
        // add to cookie
        console.log(cart);
        cart.dish = (cart.dish instanceof Array)? cart.dish:[];
        
        var index = cart.dish.indexOf(did);
        if(index==-1){
            cart.dish.push({'did':did,'number':number});
            cart.dish.push(did);
            element[0].setAttribute('class','cancelBtn');
            element.text("remove");
        }
        else{
            cart.dish.splice(index, 1);
            element[0].setAttribute('class','orderBtn');
            element.text("add");
        }
            
        console.log(cart);
    }
    
    var getDishNumber = function(did){
        for(var i=0; i<cart.dish.length; ++i)
            if(cart.dish[i].did==did)
                return cart.dish[i].number;
        return 0;
    }
    
    var updateRating = function(star){
        console.log(star)
        var children =$(star.parentNode).children();
        for(var i=0; i<children.length; ++i)
            children[i].innerHTML=whiteStart;

        var cur = star;
        var prevs = $(cur).prevAll();
        for(var i=0; i<prevs.length; ++i)
            prevs[i].innerHTML=blackStar;
        cur.innerHTML=blackStar;
        
        $(star.parentNode.parentNode).children('input').val(prevs.length+1);

    }
    
    var getTimeDiff = function(t1,t2){
        var t = (t2-t1)/1000;
        var sec = ~~t%60; t/=60;
        var min = ~~t%60; t/=60;
        var hour = ~~t%24; t/=24;
        var day = ~~t;
        
        var str = "";
        
        if(day>0){
            str += day+" day(s) ";
            str += hour+" hour(s) ";
            str += min+" min(s) ";
            str += sec+" sec(s)";
        }
        else{
            if(hour>0){
                str += hour+" hour(s) ";
                str += min+" min(s) ";
                str += sec+" sec(s)";
            }
            else{
                if(min>0){
                    str += min+" min(s) ";
                    str += sec+" sec(s)";
                }
                else{
                    str += sec+" sec(s)";
                }
            }
        }
        
        return str;
        
    }
    
</script>
</body>
</html>